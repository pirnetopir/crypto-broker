<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Krypto Broker – Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Krypto Broker – Dashboard</h1>
        <div class="flex gap-2">
          <a href="/api/trades.csv" class="px-4 py-2 rounded-xl bg-white border">Export CSV</a>
          <button id="wildBtn" class="px-4 py-2 rounded-xl bg-indigo-700 text-white">Žolíky AI – Run now</button>
          <button id="runNowBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-90">Run now</button>
          <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-white border">Refresh</button>
        </div>
      </div>

      <div class="mt-4 p-4 bg-white border rounded-xl">
        <div class="flex flex-col lg:flex-row lg:items-center lg:gap-6 gap-3">
          <div class="text-sm text-slate-600">
            Plán: <span class="font-mono">07:30</span>, <span class="font-mono">13:00</span>, <span class="font-mono">22:00</span> ({{ tz }})
            · PRESELECT: <span class="font-mono">{{ preselect }}</span>
            · PICK_TOP: <span class="font-mono">10</span>
          </div>
          <div class="flex items-center gap-2">
            <label for="budgetInput" class="text-sm text-slate-700">Rozpočet na beh (€):</label>
            <input id="budgetInput" type="number" step="10" min="0" class="w-32 px-3 py-2 border rounded-lg" placeholder="1000" />
            <button id="saveBudgetBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Uložiť</button>
            <button id="resetBudgetBtn" class="px-3 py-2 rounded-lg bg-white border">Reset</button>
          </div>
          <div id="status" class="text-sm text-slate-600 lg:ml-auto">Načítavam…</div>
        </div>
      </div>
    </header>

    <!-- Keď ešte nie je signál -->
    <section id="emptyBox" class="hidden p-6 border rounded-xl bg-white">
      <p class="mb-2">Zatiaľ nie je uložený žiadny signál.</p>
      <p class="text-sm text-slate-600">Klikni <b>Run now</b> alebo počkaj na najbližší plánovaný čas.</p>
    </section>

    <!-- Posledný signál -->
    <section id="signalBox" class="hidden">
      <div class="p-6 border rounded-xl bg-white">
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm text-slate-500">Posledná aktualizácia</div>
            <div id="sigTime" class="text-lg font-semibold">—</div>
          </div>
          <div class="flex items-center gap-2">
            <span id="regimeBadge" class="px-3 py-1 rounded-full text-sm font-semibold">—</span>
            <button id="batchInvestBtn" class="px-3 py-1 rounded bg-emerald-700 text-white">Investovať podľa váh</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-600 border-b">
                <th class="py-2">#</th>
                <th class="py-2">Symbol</th>
                <th class="py-2">Názov</th>
                <th class="py-2">Cena</th>
                <th class="py-2">Skóre</th>
                <th class="py-2">Váha</th>
                <th class="py-2">24h</th>
                <th class="py-2">ATR%</th>
                <th class="py-2">Spark</th>
                <th class="py-2">Akcia</th>
              </tr>
            </thead>
            <tbody id="picksBody"></tbody>
          </table>
        </div>

        <div id="note" class="mt-3 text-xs text-slate-500"></div>
      </div>
    </section>

    <!-- Žolíky AI -->
    <section id="wildBox" class="mt-6 p-6 border rounded-xl bg-white hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Žolíky AI (experiment)</h2>
        <div class="text-xs text-slate-500">AI odporúčanie – stále len na tvoje manuálne rozhodnutie</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-600 border-b">
              <th class="py-2">Symbol</th>
              <th class="py-2">Názov</th>
              <th class="py-2">Cena</th>
              <th class="py-2">News hits</th>
              <th class="py-2">AI verdikt</th>
              <th class="py-2">AI dôvod</th>
              <th class="py-2">Horizont</th>
              <th class="py-2">Akcia</th>
            </tr>
          </thead>
          <tbody id="wildBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Portfólio -->
    <section id="portfolioBox" class="mt-6 p-6 border rounded-xl bg-white hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Portfólio</h2>
        <div class="flex gap-2">
          <button id="reloadPfBtn" class="px-3 py-1 rounded-xl bg-white border">Obnoviť</button>
        </div>
      </div>
      <div id="pfSummary" class="text-sm text-slate-600 mb-3">—</div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-600 border-b">
              <th class="py-2">ID</th>
              <th class="py-2">Symbol</th>
              <th class="py-2">Investované (€)</th>
              <th class="py-2">Units</th>
              <th class="py-2">Buy (USD)</th>
              <th class="py-2">Last (USD)</th>
              <th class="py-2">Unrealized PnL (€)</th>
              <th class="py-2">Unrealized ROI %</th>
              <th class="py-2">SL / TP1 / TP2 (USD)</th>
              <th class="py-2">Pozn.</th>
              <th class="py-2">Akcia</th>
            </tr>
          </thead>
          <tbody id="pfBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ---------- helpers ----------
    const statusEl = document.getElementById('status');
    const emptyBox = document.getElementById('emptyBox');
    const signalBox = document.getElementById('signalBox');
    const picksBody = document.getElementById('picksBody');
    const sigTime = document.getElementById('sigTime');
    const regimeBadge = document.getElementById('regimeBadge');
    const noteEl = document.getElementById('note');

    const wildBox = document.getElementById('wildBox');
    const wildBody = document.getElementById('wildBody');

    const pfBox = document.getElementById('portfolioBox');
    const pfBody = document.getElementById('pfBody');
    const pfSummary = document.getElementById('pfSummary');

    const budgetInput = document.getElementById('budgetInput');
    const saveBudgetBtn = document.getElementById('saveBudgetBtn');
    const resetBudgetBtn = document.getElementById('resetBudgetBtn');
    const batchBtn = document.getElementById('batchInvestBtn');
    const wildBtn = document.getElementById('wildBtn');
    const BUDGET_KEY = 'kb_budget_eur';

    function getBudget(){const v=Number(localStorage.getItem(BUDGET_KEY)||'1000');return isFinite(v)&&v>=0?v:1000}
    function setBudget(v){localStorage.setItem(BUDGET_KEY,String(v))}
    function roundToStep(v,step=10){if(!isFinite(v))return 0;return Math.round(v/step)*step}
    function fmtEUR(v){try{return new Intl.NumberFormat('sk-SK',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v)}catch{return `${Math.round(v)} €`}}
    function mkSparkline(arr){ if(!arr||arr.length<2) return '';
      const w=80,h=24; const min=Math.min(...arr), max=Math.max(...arr); const span=max-min||1;
      const pts=arr.map((v,i)=>{const x=i*(w/(arr.length-1)); const y=h - ((v-min)/span)*h; return `${x.toFixed(1)},${y.toFixed(1)}`}).join(' ');
      return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline fill="none" stroke="currentColor" stroke-width="1" points="${pts}"/></svg>`;
    }

    // ---------- signal ----------
    async function loadSignal(){
      statusEl.textContent='Načítavam…';
      try{
        const r=await fetch('/signal',{cache:'no-store'});
        const data=await r.json();
        if(!data.ready){emptyBox.classList.remove('hidden');signalBox.classList.add('hidden');statusEl.textContent='Žiadny signál – skús Run now alebo počkaj.';return}
        emptyBox.classList.add('hidden');signalBox.classList.remove('hidden');statusEl.textContent='OK';
        sigTime.textContent=data.created_at||'—';
        const regime=(data.regime||'').toLowerCase();
        regimeBadge.textContent=regime==='risk-on'?'RISK-ON':'RISK-OFF';
        regimeBadge.className='px-3 py-1 rounded-full text-sm font-semibold '+(regime==='risk-on'?'bg-green-100 text-green-800':'bg-amber-100 text-amber-800');

        const budget=getBudget();
        picksBody.innerHTML='';
        (data.picks||[]).forEach((p,idx)=>{
          const w=Number(p.weight||0);
          const suggested=roundToStep(budget*w,10);
          const tr=document.createElement('tr'); tr.className='border-b';
          tr.innerHTML=`
            <td class="py-2">${idx+1}</td>
            <td class="py-2 font-semibold">${p.symbol}</td>
            <td class="py-2">${p.name}</td>
            <td class="py-2 font-mono">${Number(p.price).toFixed(6)}</td>
            <td class="py-2 font-mono">${Number(p.score).toFixed(3)}</td>
            <td class="py-2 font-mono">${w.toFixed(3)}</td>
            <td class="py-2 font-mono">${(Number(p.mom_24h)*100).toFixed(2)}%</td>
            <td class="py-2 font-mono">${(Number(p.atr_pct)*100).toFixed(2)}%</td>
            <td class="py-2 text-slate-500">${mkSparkline(p.spark||[])}</td>
            <td class="py-2">
              <button
                class="px-3 py-1 rounded bg-emerald-600 text-white"
                data-id="${p.id}" data-symbol="${p.symbol}" data-name="${p.name}"
                data-price="${Number(p.price)}" data-suggested="${suggested}"
                onclick="invest(this)">
                Investovať ${suggested>0?`(&asymp; ${fmtEUR(Number(suggested))})`:''}
              </button>
            </td>`;
          picksBody.appendChild(tr);
        });
        noteEl.textContent=data.note||'';
      }catch(e){console.error(e);statusEl.textContent='Chyba pri načítaní.'}
    }

    // ---------- wildcards ----------
    async function runWildcards(){
      const btn=wildBtn; const old=btn.textContent; btn.textContent='Hľadám…'; btn.disabled=true;
      try{
        await fetch('/run-wildcards',{cache:'no-store'});
        setTimeout(loadWildcards, 2500);
      }finally{
        setTimeout(()=>{btn.textContent=old; btn.disabled=false;}, 1500);
      }
    }
    async function loadWildcards(){
      try{
        const r=await fetch('/wildcards',{cache:'no-store'}); const data=await r.json();
        if(!data.ok){wildBox.classList.add('hidden'); return}
        const items=data.items||[];
        if(items.length===0){wildBox.classList.add('hidden'); return}
        wildBox.classList.remove('hidden');
        wildBody.innerHTML='';
        const budget=getBudget();
        items.forEach(p=>{
          const suggested=roundToStep(budget*0.1,10); // napr. ~10 % rozpočtu per žolík (môžeš zmeniť ručne)
          const horiz = Number(p.ai_horizon_days||2);
          const horizTxt = horiz < 1 ? `${Math.round(horiz*24)} h` : `${Math.round(horiz)} dní`;
          const tr=document.createElement('tr'); tr.className='border-b';
          tr.innerHTML=`
            <td class="py-2 font-semibold">${p.symbol}</td>
            <td class="py-2">${p.name}</td>
            <td class="py-2 font-mono">${Number(p.price||0).toFixed(6)}</td>
            <td class="py-2 font-mono">${p.news_hits||0}</td>
            <td class="py-2">${p.ai_approve ? '✅ odporúčané' : '⛔ zamietnuté'}</td>
            <td class="py-2">${p.ai_rationale||''}</td>
            <td class="py-2">${horizTxt}</td>
            <td class="py-2">
              ${p.ai_approve
                ? `<button class="px-3 py-1 rounded bg-indigo-700 text-white"
                    data-id="${p.id}" data-symbol="${p.symbol}" data-name="${p.name}"
                    data-price="${Number(p.price)||0}" data-suggested="${suggested}"
                    onclick="invest(this)">Investovať ${suggested>0?`(&asymp; ${fmtEUR(Number(suggested))})`:''}</button>`
                : '<span class="text-slate-400">—</span>'}
            </td>`;
          wildBody.appendChild(tr);
        });
      }catch(e){console.error(e)}
    }

    // ---------- invest / batch / close / delete ----------
    async function invest(btn){
      const coin_id=btn.getAttribute('data-id');
      const symbol=btn.getAttribute('data-symbol');
      const name=btn.getAttribute('data-name');
      const price=Number(btn.getAttribute('data-price')||'0'); // USD
      const suggested=Number(btn.getAttribute('data-suggested')||'0');
      const def=suggested>0?String(suggested):"100";
      const amt=prompt(`Koľko chceš investovať do ${symbol}? (EUR)\nNávrh: ${fmtEUR(Number(def))}`,def);
      if(!amt)return;
      const payload={coin_id,symbol,name,invested_eur:Number(amt),buy_price_usd:price};
      const r=await fetch('/api/trades',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json(); if(!j.ok) alert(j.error||'Chyba');
      loadPortfolio();
    }

    const batchBtn = document.getElementById('batchInvestBtn');
    batchBtn.addEventListener('click', async ()=>{
      const rows=[...document.querySelectorAll('#picksBody tr')];
      if(rows.length===0) return;
      const items=rows.map(tr=>{
        const btn=tr.querySelector('button[data-id]');
        const suggested=Number(btn.getAttribute('data-suggested')||'0');
        return {
          coin_id: btn.getAttribute('data-id'),
          symbol: btn.getAttribute('data-symbol'),
          name: btn.getAttribute('data-name'),
          invested_eur: suggested>0?suggested:0,
          buy_price_usd: Number(btn.getAttribute('data-price')||'0')
        }
      }).filter(x=>x.invested_eur>0);
      if(items.length===0){alert('Žiadne váhy / návrhy.'); return;}
      if(!confirm(`Vytvoriť ${items.length} obchodov celkovo za ~${fmtEUR(items.reduce((a,b)=>a+b.invested_eur,0))}?`)) return;
      const r=await fetch('/api/trades/batch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items})});
      const j=await r.json(); if(!j.ok) alert(j.error||'Chyba'); else alert('Hotovo.');
      loadPortfolio();
    });

    async function closeTrade(id){
      const amt=prompt("Za koľko EUR si predal?","120"); if(!amt)return;
      const r=await fetch(`/api/trades/${id}/close`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sold_eur:Number(amt)})});
      const j=await r.json(); if(!j.ok) alert(j.error||'Chyba');
      loadPortfolio();
    }
    async function deleteTrade(id){
      if(!confirm('Zrušiť tento otvorený obchod?')) return;
      const r=await fetch(`/api/trades/${id}`,{method:'DELETE'});
      const j=await r.json(); if(!j.ok) alert(j.error||'Chyba');
      loadPortfolio();
    }

    // ---------- budget ----------
    function initBudgetControls(){
      budgetInput.value=String(getBudget());
      saveBudgetBtn.addEventListener('click',()=>{const v=Number(budgetInput.value||'0');if(!isFinite(v)||v<0)return alert('Zadaj kladné číslo.');setBudget(v);loadSignal()});
      resetBudgetBtn.addEventListener('click',()=>{budgetInput.value='1000';setBudget(1000);loadSignal()});
      budgetInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')saveBudgetBtn.click()});
    }

    // ---------- handlers ----------
    document.getElementById('refreshBtn').addEventListener('click',()=>{loadSignal();loadPortfolio();loadWildcards()});
    document.getElementById('reloadPfBtn').addEventListener('click',loadPortfolio);
    document.getElementById('runNowBtn').addEventListener('click',async()=>{
      const btn=document.getElementById('runNowBtn');const old=btn.textContent;btn.textContent='Bežím…';btn.disabled=true;
      try{await fetch('/run-now',{cache:'no-store'});setTimeout(()=>{loadSignal();loadPortfolio()},4000)}
      finally{setTimeout(()=>{btn.textContent=old;btn.disabled=false},1500)}
    });
    wildBtn.addEventListener('click', runWildcards);

    // ---------- init ----------
    initBudgetControls(); loadSignal(); loadPortfolio(); loadWildcards(); setInterval(()=>{loadSignal();loadPortfolio()},60000);
  </script>
</body>
</html>
